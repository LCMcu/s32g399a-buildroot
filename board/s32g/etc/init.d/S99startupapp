#!/bin/busybox sh

LOG_TAG=$(basename "$0")
# 使用当前终端，如果没有可写终端则退回 /dev/console
TERM_DEV="/dev/tty"
[ ! -w "$TERM_DEV" ] && TERM_DEV="/dev/console"
# 全局重定向 stdout 和 stderr
exec > >(tee -a "$TERM_DEV" | logger -t "$LOG_TAG") 2>&1

INIT_SCRIPT="/usr/start_script/0_start.sh"
DEINIT_SCRIPT="/usr/start_script/0_stop.sh"

run_script() {
    local script="$1"
    /bin/busybox sh "$script" &
}

start() {
    local script_dir="${1:-/usr/app/start_script}"

    if [ ! -d "$script_dir" ]; then
        exit 1
    fi

    scripts=$(/bin/busybox find "$script_dir" -maxdepth 1 -type f \( -name "*.sh" -o -executable \))

    if [ -z "$scripts" ]; then
        exit 0
    fi

    for script in $scripts; do
        run_script "$script"
    done
}

# See how we were called.
case "$1" in
	start)
		# start
		echo "[INFO] Starting run 0_start.sh..."
        run_script "$INIT_SCRIPT"
		;;
	stop)
		# stop
		echo "[INFO] Stopping run 0_stop.sh..."
		run_script "$DEINIT_SCRIPT"
		;;
	restart)
		# stop
		# start
		;;
	reload)
		;;
	*)
		echo "Usage: $0 {start|stop|restart|reload}"
		exit 1
esac

exit 0